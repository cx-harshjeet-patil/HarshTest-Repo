trigger: none  # No CI on direct pushes to main

pr:
  branches:
    include:
      - main   # Trigger pipeline only for PRs targeting main

pool:
  name: 'default'   # <-- Your Windows agent pool name

variables:
  system.debug: true

stages:

  # =======================
  # Build Stage
  # =======================
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildJob
        displayName: 'Build on Windows'
        steps:
          - task: Maven@4
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              publishJUnitResults: false

  # =======================
  # Scan Stage
  # =======================
  - stage: SecurityScan
    displayName: 'Checkmarx Scan Stage'
    dependsOn: Build
    jobs:
      - job: CheckmarxJob
        displayName: 'Run Checkmarx Scans'
        steps:

          # -----------------------
          # Checkmarx AST Task
          # -----------------------
          - task: Checkmarx AST@3
            displayName: 'Checkmarx AST'
            inputs:
              CheckmarxService: 'Checkmarx-One-Service'
              tenantName: 'cx_seg'
              projectName: '$(Build.Repository.Name)'
              branchName: '$(Build.SourceBranchName)'
              scanType: 'sast,sca,iac,api-security'
              enablePrDecoration: true
              failOnHigh: false
              failOnMedium: false
              additionalParams: '--debug'

          # -----------------------
          # Manual PR Decoration
          # -----------------------
          - task: Bash@3
            displayName: 'PR Decoration'
            condition: or(eq(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.Reason'], 'Manual'))
            inputs:
              targetType: inline
              script: |
                echo "Finding cx CLI..."
                CX_EXE="$(find /home/vsts/work/_tasks -type f -name cx | head -n 1)"

                if [ -z "$CX_EXE" ]; then
                  echo "ERROR: CxOne CLI not found"
                  exit 1
                fi

                CX_DIR="$(dirname "$CX_EXE")"

                echo "CxOne CLI found : $CX_EXE"
                echo "CxOne CLI dir   : $CX_DIR"

                cd "$CX_DIR" || exit 1

                echo "PR decoration"
                echo "--scan-id    : $CHECKMARXAST_CXONESCANID"
                echo "--namespace  : $CXONE_ADONAMESPACE"
                echo "--project    : $SYSTEM_TEAMPROJECT"
                echo "--pr-number  : $SYSTEM_PULLREQUEST_PULLREQUESTNUMBER"
                echo "--base-uri   : $CXONE_BASEURI"
                echo "--tenant     : $CXONE_TENANT"

                ./cx utils pr azure --debug \
                  --scan-id "$CHECKMARXAST_CXONESCANID" \
                  --namespace "$CXONE_ADONAMESPACE" \
                  --project "$SYSTEM_TEAMPROJECT" \
                  --pr-number "$SYSTEM_PULLREQUEST_PULLREQUESTNUMBER" \
                  --token "$CXONE_PATADO" \
                  --base-uri "$CXONE_BASEURI" \
                  --tenant "$CXONE_TENANT"
