trigger: none  # No CI on direct pushes to main

pr:
  branches:
    include:
      - main   # Trigger pipeline only for PRs targeting main

pool:
  name: 'default'   # <-- Replace with your Windows agent pool name

variables:
  system.debug: true

stages:

  # =======================
  # Build Stage
  # =======================
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildJob
        displayName: 'Build on Windows'
        steps:
          - task: Maven@4
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              publishJUnitResults: false

  # =======================
  # Security Scan Stage
  # =======================
  - stage: SecurityScan
    displayName: 'Checkmarx Full Scan Stage'
    dependsOn: Build
    jobs:
      - job: CheckmarxJob
        displayName: 'Run All Checkmarx Scans'
        steps:

          # -----------------------
          # Checkmarx AST Task
          # -----------------------
          - task: Checkmarx AST@3
            displayName: 'Checkmarx AST - SAST + SCA + IaC + API'
            inputs:
              CheckmarxService: 'Checkmarx-One-Service'   # <-- Your Checkmarx service connection
              tenantName: 'cx_seg'
              projectName: '$(Build.Repository.Name)'
              branchName: '$(Build.SourceBranchName)'
              scanType: 'sast,sca,iac,api-security'
              enablePrDecoration: true
              failOnHigh: false
              failOnMedium: false
              additionalParams: '--debug'

          # -----------------------
          # Manual PR Decoration
          # -----------------------
          - task: PowerShell@2
            displayName: 'Find cx CLI and run it manually to decorate the PR (Windows)'
            condition: eq(variables['Build.Reason'], 'PullRequest')  # Only run for PRs
            inputs:
              targetType: 'inline'
              script: |
                $CX_EXE = "C:\CLI\ast-cli_2.3.38_windows_x64\cx.exe"

                if (-not (Test-Path $CX_EXE)) {
                  Write-Error "CxOne CLI not found at $CX_EXE"
                  exit 1
                }

                $CX_DIR = Split-Path $CX_EXE

                Write-Host "CxOne CLI found : $CX_EXE"
                Write-Host "CxOne CLI dir   : $CX_DIR"

                Set-Location $CX_DIR

                Write-Host "PR decoration"
                Write-Host "--scan-id       : $env:CHECKMARXAST_CXONESCANID"
                Write-Host "--namespace     : $env:CXONE_ADONAMESPACE"
                Write-Host "--cx-project    : $env:BUILD_REPOSITORY_NAME"
                Write-Host "--pr-number     : $env:SYSTEM_PULLREQUEST_PULLREQUESTID"
                Write-Host "--base-uri      : $env:CXONE_BASEURI"
                Write-Host "--client-id     : $env:CXONE_CLIENTID"
                Write-Host "--client-secret : $env:CXONE_CLIENTSECRET"
                Write-Host "--tenant        : $env:CXONE_TENANT"
                Write-Host "--project       : $env:SYSTEM_TEAMPROJECT"

                & cx utils pr azure --debug `
                  --scan-id $env:CHECKMARXAST_CXONESCANID `
                  --namespace $env:CXONE_ADONAMESPACE `
                  --project "$env:SYSTEM_TEAMPROJECT" `
                  --pr-number $env:SYSTEM_PULLREQUEST_PULLREQUESTID `
                  --token $env:CXONE_PATADO `
                  --base-uri $env:CXONE_BASEURI `
                  --client-id $env:CXONE_CLIENTID `
                  --client-secret $env:CXONE_CLIENTSECRET `
                  --tenant $env:CXONE_TENANT
