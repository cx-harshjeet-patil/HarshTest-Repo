trigger:
  - main

pr:
  - main

pool:
  name: 'default'   # <-- Replace with your real Windows agent pool name

variables:
  system.debug: true

stages:

  # =======================
  # Build Stage
  # =======================
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildJob
        displayName: 'Build on Windows'
        steps:
          - task: Maven@4
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              publishJUnitResults: false

  # =======================
  # Security Scan Stage
  # =======================
  - stage: SecurityScan
    displayName: 'Checkmarx Full Scan Stage'
    dependsOn: Build
    jobs:
      - job: CheckmarxJob
        displayName: 'Run All Checkmarx Scans'
        steps:

          # Checkmarx AST task (SAST + SCA + IaC + API)
          - task: Checkmarx AST@3
            displayName: 'Checkmarx AST - SAST + SCA + IaC + API'
            inputs:
              CheckmarxService: 'Checkmarx-One-Service'   # <-- Your Checkmarx service connection
              tenantName: 'cx_seg'
              projectName: '$(Build.Repository.Name)'
              branchName: '$(Build.SourceBranchName)'
              scanType: 'sast,sca,iac,api-security'
              enablePrDecoration: true
              failOnHigh: false
              failOnMedium: false
              additionalParams: '--debug --filter "status=NEW"'

          # Optional: Manual PR Decoration using PowerShell (Windows)
          - task: PowerShell@2
            displayName: 'Find cx CLI and run it manually to decorate the PR (Windows)'
            inputs:
              targetType: 'inline'
              script: |
                $CX_EXE = "C:\CLI\ast-cli_2.3.38_windows_x64\cx.exe"

                if (-not (Test-Path $CX_EXE)) {
                  Write-Error "CxOne CLI not found at $CX_EXE"
                  exit 1
                }

                $CX_DIR = Split-Path $CX_EXE

                Write-Host "CxOne CLI found : $CX_EXE"
                Write-Host "CxOne CLI dir   : $CX_DIR"

                Set-Location $CX_DIR

                Write-Host "PR decoration"
                Write-Host "--scan-id    : $env:CHECKMARXAST_CXONESCANID"
                Write-Host "--namespace : $env:CXONE_ADONAMESPACE"
                Write-Host "--project   : $env:BUILD_REPOSITORY_NAME"
                Write-Host "--pr-number : $env:SYSTEM_PULLREQUEST_PULLREQUESTID"
                Write-Host "--base-uri  : $env:CXONE_BASEURI"
                Write-Host "--client-id : $env:CXONE_CLIENT"
                Write-Host "--tenant    : $env:CXONE_TENANT"
                Write-Host "--ado-proj  : $env:SYSTEM_TEAMPROJECT"

                & $CX_EXE utils pr azure --debug `
                  --scan-id $env:CHECKMARXAST_CXONESCANID `
                  --namespace $env:CXONE_ADONAMESPACE `
                  --project "$env:SYSTEM_TEAMPROJECT" `
                  --pr-number $env:SYSTEM_PULLREQUEST_PULLREQUESTID `
                  --base-uri $env:CXONE_BASEURI `
                  --client-id $env:CXONE_CLIENT `
                  --client-secret $env:CXONE_SECRET `
                  --tenant $env:CXONE_TENANT
